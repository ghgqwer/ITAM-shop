<script>import { onMount, onDestroy, getContext } from "svelte";
import { Map, Tooltip } from "leaflet";
import { Compare } from "./utils/index";
export let latLng = void 0;
export let options = {};
export let instance = void 0;
let parentContext = getContext(Map);
const { getMap, getOverlay } = parentContext;
let tooltip;
let htmlElement;
let ready = false;
let compare;
$: map = getMap?.();
$: layer = getOverlay?.();
$: instance = tooltip;
onMount(() => {
  let mergeOptions = {
    ...options
  };
  if (htmlElement) {
    mergeOptions = {
      ...mergeOptions,
      content: htmlElement
    };
  }
  if (!latLng && layer) {
    tooltip = new Tooltip(mergeOptions, layer);
  } else if (latLng) {
    tooltip = new Tooltip(latLng, mergeOptions);
  } else {
    throw new Error("Prop latLng is required.");
  }
  compare = new Compare(tooltip, { ...$$props, options: mergeOptions });
  ready = true;
});
$: if (map) {
  if (tooltip) {
    compare.updateProps($$props);
    if (!layer) {
      tooltip.openOn(map);
    } else {
      let tooltipContent = tooltip.options.content || "";
      layer.bindTooltip(tooltipContent);
    }
    compare.storeProps($$props);
  }
}
function reset() {
  tooltip?.remove();
  tooltip = void 0;
}
onDestroy(() => {
  reset();
});
</script>

{#if $$slots.default}
	<div style="display: none">
		<div bind:this={htmlElement} {...$$restProps}>
			{#if ready}
				<slot />
			{/if}
		</div>
	</div>
{/if}
